<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Tornadoes</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link href="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.min.css" rel="stylesheet">
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.1/mapbox-gl.css' rel='stylesheet' />
  

    <style>
        body {
            margin:0;
            padding:0;
        }
        
    </style>
</head>
<body>

<div class='grid bg-gray-dark absolute h-full w-full'>
    <div class='col col--12 border-b border--white color-white'>
        <h1 class='txt-h2 mx36 my24 inline-block'>Tornado Damage in the US: 2010-2018</h1>
        <p class='fr mr24 mt36'>Source: <a class='link' target='_blank' href='https://www.spc.noaa.gov/gis/svrgis/'>NOAA Storm Prediction Center</a></p>
    </div>
    <div class='col col--12 h-full relative'>
        <div id='map' class='w-full h-full'></div>
        <div id='time-slider' class='w180 bg-white absolute top left mt18 ml18 round shadow-darken10 px12 py12 txt-s'>
                <strong class='block mb6 txt-l'><label id="year"></label></strong>
            <input id="slider" type="range" min="2010" max="2018" step="1" value="2010" />
        </div>
        <div id='info-box' class='w240 bg-white absolute top right mt18 mr18 round shadow-darken10 px12 py12 txt-s'>
            <strong class='block mb6 txt-l'>Click any tornado path to learn more.</strong>
        </div>
        <div id='legend' class='w180 bg-white absolute top left mt120 ml18 round shadow-darken10 px12 py12 txt-s'>
            <strong class='block mb6 txt-m'>Enhanced Fujita Scale</strong>
            <ul class='ul mb6'></ul>
        </div>
    </div>
</div>

<script async defer src="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.1/mapbox-gl.js'></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
<!-- <script type="module">
    import { MapboxGradientBoxControl, MapboxInfoBoxControl } from "/node_modules/mapbox-gl-infobox";
</script>
<script type="module">
    import { Map as MapboxMap } from "/node_modules/mapbox-gl";
</script>
<script type="module">
    import "/node_modules/mapbox-gl-infobox/styles.css";
</script> -->

<script>

    // access token
    mapboxgl.accessToken = 'pk.eyJ1IjoiZWlsZWVuZ3JhZHkiLCJhIjoiY2pvNG00eXVjMDFlcjNxcW1yZ3I2OTJ2ZSJ9.l2EtBykdOJSCNiszd2NbaA';

    // create a new map
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/dark-v9', // stylesheet location
        center: [-99.00419461981159, 39.09686673109556], // starting position [lng, lat]
        zoom: 3.52 // starting zoom
    });

    // map.addControl(new mapboxgl.NavigationControl());

    // map.addControl(new MapboxInfoBoxControl());

    // define initial bounds of map to revert to when time slider changes
    var initialBounds = [-60.29801479704621, 46.228291513703226, -137.7103744425777, 31.164291511296398]
     
    var years = [
        '2010',
        '2011',
        '2012',
        '2013',
        '2014',
        '2015',
        '2016',
        '2017',
        '2018'
    ];

    var colorCodes = {
        0: "#85c4c9",
        1: "#fcde9c",
        2: "#f58670",
        3: "#e34f6f",
        4: "#d72d7c",
        5: "#7c1d6f"
    }

    var labelCodes = {
        0: "EF0",
        1: "EF1",
        2: "EF2",
        3: "EF3",
        4: "EF4",
        5: "EF5"
    }

    var hoveredPathId = null;

    var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    map.on('load', function() {
        d3.json('data/tornadoes-filtered.json').then(geojson => {
            addLayer(geojson);
            addLegend(geojson);
        });
    });

    function addLayer(geojson) {
        map.addSource('tornadoes', {
            'type': 'geojson',
            'data': geojson,
            'generateId': true
        });

        map.addLayer({
            'id': 'tornado-paths',
            'type': 'line',
            'source': 'tornadoes', // set data source defined above
            'paint': {
                "line-color": [
                    "match",
                    ["number", ["get", "mag"]],
                    0, colorCodes[0],
                    1, colorCodes[1],
                    2, colorCodes[2],
                    3, colorCodes[3],
                    4, colorCodes[4],
                    5, colorCodes[5],
                    "#000000"
                ],
                "line-opacity": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    1,
                    0.85
                ],
                "line-width": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    6,
                    3
                ]
            },
            'layout': {
                "line-cap": "round"
            }
        });

        map.loadImage('images/tornado.png', function(err, image) {
            if (err) throw error;
            map.addImage('tornado', image, {
                'sdf': 'true'
            });
        });

        map.on('mousemove', 'tornado-paths', function(e) {

            map.getCanvas().style.cursor = 'pointer';

            if (e.features.length > 0) {
                if (hoveredPathId) {
                    map.setFeatureState(
                    { source: 'tornadoes', id: hoveredPathId },
                    { hover: false }
                    );
                }
                hoveredPathId = e.features[0].id;
                map.setFeatureState(
                    { source: 'tornadoes', id: hoveredPathId },
                    { hover: true }
                );
            }
        });

        map.on('mouseleave', 'tornado-paths', function() {

            map.getCanvas().style.cursor = '';

            if (hoveredPathId) {
                map.setFeatureState(
                    { source: 'tornadoes', id: hoveredPathId },
                    { hover: false }
                );
            }
            hoveredPathId = null;
        });

        // set intial filter to 2010
        filterBy(2010);

        document
            .getElementById('slider')
            .addEventListener('input', function(e) {

                // check if the moving tornado icon exists, and remove it if so
                var mapLayer = map.getLayer('point');
                if(typeof mapLayer !== 'undefined') {
                    // Remove map layer & source.
                    map.removeLayer('point').removeSource('point');
                }

                document.getElementById('info-box').innerHTML="<strong class='block mb6 txt-l'>Click any tornado path to learn more.</strong>"

                // revert map to initial bounds
                map.fitBounds(initialBounds);

                var year = parseInt(e.target.value);
                filterBy(year);
            });
    }

    function filterBy(year) {

        var filters = ['==', 'yr', year];
        map.setFilter('tornado-paths', filters);
        
        // Set the label to the year
        document.getElementById('year').textContent = year;
    }

    function addLegend(geojson) {
        var listItems = '';
        for(var code in colorCodes) {
            listItems += "<li class='li h-full txt-m'><span class='w24 h18 mt6 fl mr12' style='background:" + colorCodes[code] +"'></span>" + labelCodes[code] + "</li>"
        }
        d3.select("#legend ul").html(listItems);
    }

    var steps = 90;

    map.on('click', 'tornado-paths', function(e) {

        let features = map.queryRenderedFeatures(e.point);
        console.log(features);
        let props = e.features[0].properties
        console.log(e.features[0]);

        let windSpeed = getWindSpeed(props.mag)
        let damage = getDamage(props.mag)

        let moreDetails = "<strong class='block mb6 txt-l'>Tornado Details</strong>"
                            +"This tornado struck on " + props.date 
                            + " and was a magnitude EF" + props.mag 
                            + " on the Enhanced Fujita Scale. Wind speeds were " + windSpeed 
                            + " mph, causing " + damage 
                            + " damage."
                            + "<li class='li h-full txt-s'>Property Loss: $" + e.features[0].properties.loss + " million</li>"
                            + "<li class='li h-full txt-s'>Crop Loss: $" + props.closs + " million</li>"

        document.getElementById('info-box').innerHTML=moreDetails;

        let coordinates = e.features[0].geometry.coordinates;

        
        let bounds = coordinates.reduce(function(bounds, coord) {
            return bounds.extend(coord);
        }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

        // console.log(coordinates)

        map.fitBounds(bounds, {
            padding: {
                'bottom': 80,
                'left': 250,
                'right': 300,
                'top': 150
            }
        });

        // let coordinates = [e.features[0].properties.slon, e.features[0].properties.slat];

        let turfStart = turf.point([e.features[0].properties.slon, e.features[0].properties.slat]);
        let turfEnd = turf.point([e.features[0].properties.elon, e.features[0].properties.elat]);

        // let brng = turf.bearing(turfStart, turfEnd);

        // let startPoint = [e.features[0].properties.slon, e.features[0].properties.slat];
        // let endPoint = [e.features[0].properties.elon, e.features[0].properties.elat];

        // let line = turf.lineString(e.features[0].geometry.coordinates)
        // let bbox = turf.bbox(line);

        // map.fitBounds(bbox, {
            // padding: {
            //     'bottom': 80,
            //     'left': 250,
            //     'right': 300,
            //     'top': 150
            // }
        // });

        map.once('moveend', function(e) {

            let mapLayer = map.getLayer('point');

            if(typeof mapLayer !== 'undefined') {
                // Remove map layer & source.
                map.removeLayer('point').removeSource('point');
            } 

            var movePoint = {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'properties': {},
                        'geometry': {
                            'type': 'Point',
                            'coordinates': coordinates[0]
                        }
                    }
                ]
            };

            var route = {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [coordinates[0], coordinates[1]]
                    }
                    }
                ]
                };


            let turfStart = turf.point(coordinates[0]);
            let turfEnd = turf.point(coordinates[1]);
            // console.log(coordinates[0]);
            // console.log(coordinates[1]);

            let options = {units: 'miles'};

            let arc = [];

            let lineDistance = turf.distance(turfStart, turfEnd, options);

            for (var i = 0; i < lineDistance; i += lineDistance / steps) {
                let segment = turf.along(route.features[0], i, options);
                arc.push(segment.geometry.coordinates);
            }
            
            route.features[0].geometry.coordinates = arc;

            let counter = 0;

            map.addSource('point', {
                'type': 'geojson',
                'data': movePoint
            });

            map.addLayer({
                'id': 'point',
                'source': 'point',
                'type': 'symbol',
                'layout': {
                    'icon-image': 'tornado',
                    'icon-rotation-alignment': 'map',
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true,
                    'icon-size': 0.1,
                },
                'paint': {
                    'icon-color': '#9AD8F4'
                }
            });

            // map.flyTo({
            //     center: coordinates,
            //     zoom: 10,
            //     pitch: 30,
            //     bearing: brng
            // })

            function animate() {
            // Update point geometry to a new position based on counter denoting
            // the index to access the arc.
            movePoint.features[0].geometry.coordinates =
            route.features[0].geometry.coordinates[counter];
            
            // Calculate the bearing to ensure the icon is rotated to match the route arc
            // The bearing is calculate between the current point and the next point, except
            // at the end of the arc use the previous point and the current point
            // movePoint.features[0].properties.bearing = turf.bearing(
            // turf.point(
            // route.features[0].geometry.coordinates[
            // counter >= steps ? counter - 1 : counter
            // ]
            // ),
            // turf.point(
            // route.features[0].geometry.coordinates[
            // counter >= steps ? counter : counter + 1
            // ]
            // )
            // );
            
            // Update the source with this new data.
            map.getSource('point').setData(movePoint);
            
            // Request the next frame of animation so long the end has not been reached.
            if (counter < steps) {
                requestAnimationFrame(animate);
            }
            
            counter = counter + 1;

            // console.log(movePoint.features[0].geometry.coordinates)
        }

        animate(counter);

        })
    });

    function getWindSpeed(mag) {
        if (mag === 0) {
            return "between 65 and 85"
        } else if (mag === 1) {
            return "between 86 and 110"
        } else if (mag === 2) {
            return "between 111 and 135"
        } else if (mag === 3) {
            return "between 136 and 165"
        } else if (mag === 4) {
            return "between 166 and 200"
        } else if (mag === 5) {e
            return "of more than 200"
        } 
    };

    function getDamage(mag) {
        if (mag === 0) {
            return "light"
        } else if (mag === 1) {
            return "moderate"
        } else if (mag === 2) {
            return "considerable"
        } else if (mag === 3) {
            return "severe"
        } else if (mag === 4) {
            return "devastating"
        } else if (mag === 5) {
            return "incredible"
        } 
    };



</script>

</body>
</html>